{% load staticfiles %}
{% load cache %}
<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="{% static 'main/css/bootstrap.css' %}" />
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.4.min.js"></script>
        <title>A Simple Page with CKEditor</title>
    </head>
    <body>
        <p id="saved-msg" class="alert alert-success" style="width: 80px; position: absolute; right: 0; margin-right: 30px; display: none;" ></p>

        <form>
            <textarea name="editor1" id="id_body" rows="10" cols="80">
                Sample Text Sample Text Sample Text Sample Text Sample Text Sample Text
            </textarea>
            <script src="{% static 'main/js/lib/jquery/jquery-2.1.1.min.js' %} "></script>
            <script src="{% static 'main/js/lib/ckeditor/ckeditor.js' %} "></script>
            <div id="status"></div>
            <ul id="objects"></ul>

            <script type="text/javascript">
                AWS.config.update({accessKeyId: 'AKIAIIYFFFOR2KL2MRUQ', secretAccessKey: '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'});
                AWS.config.region = 'us-east-1';
                uploadPath = 'main/images/';

                function debounce(func, wait, immediate) {
                    var timeout;
                    return function() {
                        var context = this, args = arguments;
                        var later = function() {
                            timeout = null;
                            if (!immediate) func.apply(context, args);
                        };
                        var callNow = immediate && !timeout;
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                        if (callNow) func.apply(context, args);
                    };
                };

                function editAreaSmallerThanWindow(iframeDoc) {
                    return iframeDoc.getElementsByTagName('html')[0].clientHeight >
                           iframeDoc.getElementsByTagName('body')[0].clientHeight;
                }

                function padEditArea(ckeditor, count) {
                    console.log('padding edit area');
                    var padding = Array(40).join('<p>&nbsp;</p>');
                    ckeditor.setData(ckeditor.getData() + padding)
                }

                function upload(file) {
                    var bucket = new AWS.S3({params: {Bucket: 'awsblogstore'}});
                    console.log("Uploading file: " + file.name);
                    var params = {Key: uploadPath + file.name, ContentType: file.type, Body: file, ACL: "public-read"};
                    return new Promise(function(resolve, reject) {
                        bucket.upload(params, function (err, data) {
                            if (!err) resolve(data);
                            else reject(err);
                        });
                    });
                }

                function insertImage(s3Object) {
                    console.log("Success!");
                    var editor = CKEDITOR.instances.id_body;
                    var elem = editor.document.createElement('img', {
                        attributes: {
                            src: s3Object.Location
                        }
                    });
                    console.log("Adding image to document");
                    editor.insertElement(elem);
                }

                function popError(err) {
                    alert(err);
                }


                function dropHandler(e) {
                    e.preventDefault();
                    var file = e.dataTransfer.files[0];
                    console.log("received file from drop: " + file);
                    upload(file).then(insertImage, popError);
                };

                function saveArticle(ckeditor) {
                    var editor = CKEDITOR.instances.id_body;
                    var saveMsg = $('#saved-msg');

                    saveMsg.text("Saving..");
                    saveMsg.show();
                    setTimeout(function() {
                        saveMsg.text('Saved')
                        setTimeout(function() {
                            saveMsg.hide()
                        }, 1000)
                    }, 1000);

                }

                function getCsrfCookie() {
                    var cookie, _i, _len, _ref, _results;
                    _ref = document.cookie.split(';');
                    _results = [];
                    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                      cookie = _ref[_i];
                      if (cookie.indexOf('csrftoken') > -1) {
                        _results.push($.trim(cookie.split('=')[1]));
                      }
                    }
                  return _results;
                };

                $(document).ready(function() {
                    $('[for=id_body]').hide();
                    CKEDITOR.replace('id_body');

                    setTimeout(function() {
{#                        console.log("Running");#}
                        var ckeditor = CKEDITOR.instances.id_body;

                        var iframe = document.getElementsByTagName('iframe')[0];
                        var iFrameDoc = iframe.contentDocument || iframe.contentWindow.document;
                        if (editAreaSmallerThanWindow(iFrameDoc)) {
                            padEditArea(ckeditor)
                        }

                        iFrameDoc.ondragover = function(e) { console.log(1); return false; };
                        iFrameDoc.ondrop = dropHandler

                        ckeditor.on('change', debounce(saveArticle, 500));
                        },
                        1000
                    );



    {#                    setTimeout(function() {#}
    {##}
    {#                        $('iframe:first').contents().find('html').on('dragover', function (evt) {#}
    {#                            evt.stopPropagation();#}
    {#                            evt.preventDefault()#}
    {#                            $(evt).dropEffect = 'copy';#}
    {#                            console.log(3);#}
    {#                        });#}
    {##}
    {##}
    {#                        $('iframe:first').contents().find('html').on('drop', function (evt) {#}
    {#                            evt.stopPropagation();#}
    {#                            evt.preventDefault()#}
    {#                            $(evt).dropEffect = 'copy';#}
    {#                            console.log(6);#}
    {#                            console.log(evt);#}
    {#                        });#}
    {##}
    {#                        $('iframe:first').contents().on('drop', function (evt) {#}
    {#                            evt.stopPropagation();#}
    {#                            evt.preventDefault();#}
    {#                        });#}
    {##}
    {#                    }, 1000);#}
    {##}
    {##}
    {#                    setTimeout(function() {#}
    {#                        var editor = CKEDITOR.instances.id_body;#}
    {#                        console.log(editor.getSelection());#}
    {#                        var elem = editor.document.createElement('img', {#}
    {#                            attributes: {#}
    {#                                src: 'http://i.imgur.com/aJYZ20v.gif',#}
    {#                            }#}
    {#                        });#}
    {##}
    {#                        editor.insertElement(elem);#}
    {#                    }, 1500);#}

{#                    setTimeout(function() {#}
{#                        console.log("running");#}
{#                        CKEDITOR.instances.id_body.on('click', function() {#}
{#                            console.log("Hello world!");#}
{#                        });#}
{##}
{#                        CKEDITOR.on('change', function() {#}
{#                            console.log("Hello world!");#}
{#                        });#}
{#                    }, 500);#}
                })

            </script>
        </form>
        <div id="example-one">
        <style scoped>
          #example-one { margin-bottom: 0px; }
          [contenteditable="true"] { padding: 0px; outline: 2px dashed #CCC; }
          [contenteditable="true"]:hover { outline: 2px dashed #0090D2; }
        </style>
        <p></p>
        </div>
    </body>
</html>
