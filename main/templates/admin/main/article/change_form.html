{% extends 'admin/change_form.html' %}
{% load staticfiles %}

{% block extrahead %}
    {{ block.super }}

    <link rel="stylesheet" type="text/css" href="{% static 'main/css/main/main.css' %}" />
    <link href='http://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="{% static 'main/css/base/code.css' %}" />
    <link rel="stylesheet" type="text/css" href="{% static 'main/css/bootstrap.css' %}" />

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.26.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.8.0/lodash.js"></script>
    <script src="{% static 'main/js/lib/jquery/jquery-2.1.1.min.js' %} "></script>
    <script src="{% static 'main/js/lib/ckeditor/ckeditor.js' %} "></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script type="text/javascript">
        AWS.config.update({accessKeyId: '{{ AWS_ACCESS_KEY_ID }}', secretAccessKey: '{{AWS_SECRET_ACCESS_KEY}}'});
        AWS.config.region = 'us-east-1';
        uploadPath = window.location.pathname.replace('admin', 'images').slice(1);

        function clientHeight(iframe, tag) {
            return iframe.getElementsByTagName(tag)[0].clientHeight
        }

        function editAreaSmallerThanWindow(iframe) {
            return clientHeight(iframe, 'html') > clientHeight(iframe, 'body');
        }

        function padEditArea(ckeditor) {
            var padding = Array(40).join('<p>&nbsp;</p>');
            ckeditor.setData(ckeditor.getData() + padding)
        }

        function upload(file) {
            var bucket = new AWS.S3({params: {Bucket: 'awsblogstore'}});
            console.log("Uploading file: " + uploadPath + file.name);
            var params = {Key: uploadPath + file.name, ContentType: file.type, Body: file, ACL: "public-read"};
            return new Promise(function(resolve, reject) {
                bucket.upload(params, function (err, data) {
                    if (!err) resolve(data);
                    else reject(err);
                });
            });
        }

        function insertImage(s3Object) {
            var editor = CKEDITOR.instances.id_body;
            var elem = editor.document.createElement('img', {
                attributes: {
                    src: s3Object.Location
                }
            });
            console.log("Adding image to document");
            editor.insertElement(elem);
        }

        function orPopError(err) {
            alert(err);
        }

        function dropHandler(e) {
            e.preventDefault();
            var file = e.dataTransfer.files[0];
            console.log("received file from drop: " + file);
            upload(file).then(insertImage, orPopError);
        };

        function doNothing(e) {}

        function saveArticle(ckeditor) {
            var editor = CKEDITOR.instances.id_body;
            var saveMsg = $('#saved-msg');

            saveMsg.text("Saving..");
            saveMsg.show();

            var request = $.ajax({
                url: './patch-article/',
                data: {
                    'body': ckeditor.getData(),
                    'csrfmiddlewaretoken': '{{ csrf_token}}'
                },
                type: 'POST'
            });

            request.done(function(response) {
                saveMsg.text('Saved')
                setTimeout(function() {
                    saveMsg.hide()
                }, 1500);
            });

            request.fail(function(response) {
                alert("Uh oh! We failed while writing your changes. Make sure to manually save!");
            })

            setTimeout(function() {

            }, 1000);
        }

        function hasCsrf(str) { return str.indexOf('csrftoken') > -1 }
        function cookieValue(str) { return str.split('=')[1].trim() }

        function getCsrfCookie() {
            return document.cookie.split(';').filter(hasCsrf).map(cookieValue);
        };

        function slugify(text) {
            return text.replace(/\W+/g, '-').toLowerCase();
        }

        $(document).ready(function() {
            $('[for=id_body]').hide();
            CKEDITOR.replace('id_body');

            var slugField = $('#id_slug');
            var titleField = $('#id_title')

            titleField.on('keyup', function(e) {
                slugField.val(slugify($(this).val()));
            });

            setTimeout(function() {
                var ckeditor = CKEDITOR.instances.id_body;

                var iframe = document.getElementsByTagName('iframe')[0];
                var iFrameDoc = iframe.contentDocument || iframe.contentWindow.document;

                if (editAreaSmallerThanWindow(iFrameDoc)) {
                    padEditArea(ckeditor)
                }

                iFrameDoc.ondragover = doNothing;
                iFrameDoc.ondrop = dropHandler;

                ckeditor.on('change', _.debounce(function() {saveArticle(ckeditor);}, 1000));
                },
                1000
            );
        })

    </script>

<style>
    #id_related, #id_tags {
        width: 300px;
        min-height: 100px;
    }
</style>


{% endblock %}

{% block content %}
    {{ block.super }}

    <p id="saved-msg" class="alert alert-success" style="
          width: 80px;
          position: fixed;
          right: 0px;
          margin-right: 30px;
          display: none;
          top: 0;
          z-index: 9999;
    "></p>
{% endblock %}
